<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Click PvP Online</title>
  <!-- Fuente Press Start 2P -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    /* Evitar la selección de texto en todos los elementos */
    * {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    /* Deshabilitar el overscroll (movimiento por defecto en móviles) */
    html, body {
      overscroll-behavior: none;
      overflow: auto;
    }

    /* Scrollbars personalizados (invisibles) para Chrome, Safari y Opera */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: transparent;
    }

    /* Para Firefox: ocultar scrollbars */
    html {
      scrollbar-width: none;
      scrollbar-color: transparent transparent;
    }

    /* Global Styles */
    body {
      font-family: 'Press Start 2P', cursive;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #0d0d0d, #262626);
      position: relative;
      color: #fff;
      text-shadow: 0 0 10px rgba(173,216,230,0.7);
    }
    /* Fondo animado y overlay de ruido */
    body::after {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='150' height='150'><filter id='noise'><feTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/></filter><rect width='100%25' height='100%25' filter='url(%23noise)' /></svg>");
      opacity: 0.2;
      z-index: -2;
      animation: moveNoise 10s linear infinite;
    }
    @keyframes moveNoise {
      from { transform: translate(0,0); }
      to { transform: translate(-100px, -100px); }
    }
    /* Partículas de fondo */
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -3;
    }
    /* Contenedor principal */
    .container {
      width: 90%;
      max-width: 500px;
      text-align: center;
      border-radius: 20px;
      padding: 30px 40px;
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      background: rgba(20,20,20,0.6);
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 15px 35px rgba(0,0,0,0.6);
      position: relative;
      z-index: 1;
    }
    /* Secciones internas */
    #lobby, #game, #stats, #joinSection, #roomInfo, #roomClosed {
      width: 100%;
      text-align: center;
    }
    h1, p, #result {
      color: #fff;
      text-shadow: 0 0 10px rgba(173,216,230,0.7);
    }
    h1 {
      font-size: 1.6em;
      margin-bottom: 20px;
    }
    p {
      font-size: 0.8em;
      margin: 10px 0;
    }
    /* Estilos de inputs */
    input[type="text"] {
      width: 80%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid rgba(173,216,230,0.7);
      border-radius: 10px;
      font-size: 0.8em;
      background: rgba(255,255,255,0.1);
      color: #fff;
      text-align: center;
      outline: none;
    }
    /* Botones generales (base) */
    .buttons button,
    .btn {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      font-size: 0.8em;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 5px rgba(173,216,230,0.7), 0 0 10px rgba(173,216,230,0.7);
    }
    .buttons button:hover,
    .btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(173,216,230,0.8), 0 0 15px rgba(173,216,230,0.8);
    }
    .buttons button:active,
    .btn:active {
      transform: scale(0.95);
    }
    /* Botón para crear sala: fondo gris con texto negro */
    .btn-create {
      background: linear-gradient(45deg, #444, #777);
      color: black;
    }
    /* Botón Unirse y Random Room */
    .btn-join {
      background: linear-gradient(45deg, #008CBA, #00aced);
      color: black;
    }
    /* Botón Salir */
    .btn-leave {
      background: linear-gradient(45deg, #d9534f, #c9302c);
      color: black;
      cursor: pointer;
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      font-size: 0.8em;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 5px rgba(173,216,230,0.7), 0 0 10px rgba(173,216,230,0.7);
    }
    /* Botón Cerrar Sala (para el creador) en rojo */
    .btn-close {
      background: linear-gradient(45deg, #d9534f, #c9302c);
      color: black;
      cursor: pointer;
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      font-size: 0.8em;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 5px rgba(173,216,230,0.7), 0 0 10px rgba(173,216,230,0.7);
    }
    .btn-close:hover {
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(173,216,230,0.8), 0 0 15px rgba(173,216,230,0.8);
    }
    .btn-close:active {
      transform: scale(0.95);
    }
    /* Botón INICIAR: siempre visible para el creador */
    .btn-start {
      background: linear-gradient(45deg, #777, #555);
      color: black;
      cursor: not-allowed;
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      font-size: 0.8em;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 5px rgba(173,216,230,0.7), 0 0 10px rgba(173,216,230,0.7);
    }
    .btn-start.active {
      background: linear-gradient(45deg, #5cb85c, #4cae4c);
      color: black;
      cursor: pointer;
    }
    /* Botón Volver al menú (para sala cerrada) */
    .btn-back {
      background: linear-gradient(45deg, #444, #777);
      color: black;
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 5px rgba(173,216,230,0.7), 0 0 10px rgba(173,216,230,0.7);
    }
    .btn-back:hover {
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(173,216,230,0.8), 0 0 15px rgba(173,216,230,0.8);
    }
    .btn-back:active {
      transform: scale(0.95);
    }
    /* Sección diferenciada para sala y juego */
    #lobby {
      background: rgba(20,20,20,0.7);
      border: 1px solid rgba(255,255,255,0.1);
    }
    #game {
      background: rgba(30,30,30,0.8);
      border: 1px solid rgba(255,255,255,0.15);
    }
    /* Encabezado del juego */
    #game-header {
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    #game-header p {
      margin: 5px 0;
      font-weight: bold;
      font-size: 0.8em;
    }
    /* Área de clicks: círculo */
    .circle {
      width: 150px;
      height: 150px;
      margin: 20px auto;
      border-radius: 50%;
      background: radial-gradient(circle at center, #666, #333),
                  url("https://www.transparenttextures.com/patterns/brick-wall.png");
      background-size: cover;
      background-blend-mode: multiply;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      overflow: hidden;
      pointer-events: none;
    }
    .circle:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    }
    .circle:active {
      transform: scale(0.95);
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    }
    .circle::before {
      content: "";
      position: absolute;
      top: -5px;
      left: -5px;
      right: -5px;
      bottom: -5px;
      background: linear-gradient(45deg, #555, #888, #555);
      border-radius: 50%;
      z-index: -1;
      filter: blur(8px);
      animation: rotateBorder 4s linear infinite;
    }
    @keyframes rotateBorder {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Partículas en el círculo */
    .click-particle {
      position: absolute;
      border-radius: 50%;
      width: 8px;
      height: 8px;
      background: #fff;
      pointer-events: none;
      opacity: 0.8;
      animation: particle 0.6s forwards;
    }
    @keyframes particle {
      0% { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(3); opacity: 0; }
    }
    #result {
      font-size: 0.8em;
      font-weight: bold;
      margin-top: 20px;
    }
    /* Pantalla de estadísticas */
    #stats {
      color: #fff;
      display: none;
      text-align: center;
      flex-direction: column;
      align-items: center;
    }
    /* Notificación personalizada */
    #notification {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #notification-content {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    #notification-content p {
      margin: 0 0 10px 0;
      font-size: 0.9em;
    }
    #notification-content button {
      padding: 5px 10px;
      border: none;
      background: #00f;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
    }
    /* Sección de sala: lista de jugadores */
    #roomInfo {
      text-align: center;
    }
    #playersList {
      margin: 10px 0;
    }
    #playersList ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    #playersList li {
      font-size: 0.8em;
      margin: 5px 0;
    }

    /* Media query para pantallas medianas (tablets) */
    @media (max-width: 768px) {
      .container {
        max-width: 90%;
        padding: 20px 30px;
      }
      h1 {
        font-size: 1.4em;
      }
      p, input[type="text"], .buttons button, .btn {
        font-size: 0.8em;
      }
      input[type="text"] {
        padding: 10px;
      }
      .buttons button, .btn {
        padding: 8px 16px;
      }
    }

    /* Media query para pantallas pequeñas (móviles) */
    @media (max-width: 480px) {
      .container {
        max-width: 95%;
        padding: 15px 20px;
      }
      h1 {
        font-size: 1.2em;
      }
      p, input[type="text"], .buttons button, .btn {
        font-size: 0.7em;
      }
      input[type="text"] {
        padding: 8px;
      }
      .buttons button, .btn {
        padding: 6px 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Partículas de fondo -->
  <div id="particles-js"></div>
  
  <!-- Contenedor principal -->
  <div class="container" id="container">
    <!-- Sección de Lobby -->
    <div id="lobby">
      <h1>Click PvP Online</h1>
      <p>Enter your username:</p>
      <input type="text" id="username" placeholder="User name">
      
      <div id="mainButtons" class="buttons">
        <button id="createRoomBtn" class="btn-create">Create Room</button>
        <button id="joinRoomBtn" class="btn-join">Join a room</button>
        <button id="randomRoomBtn" class="btn-join">Random Room</button>
        <button id="practiceModeBtn" class="btn-create">Practice Mode</button>
      </div>
      
      <!-- Sección para ingresar código de sala al unirse -->
      <div id="joinSection" style="display: none;">
        <p>Enter the room code:</p>
        <input type="text" id="roomCodeInput" placeholder="Room code">
        <div class="buttons">
          <button id="confirmJoinBtn" class="btn-join">Join</button>
          <button id="backBtn" class="btn-leave">Go back</button>
        </div>
      </div>
      
      <!-- Información de sala (una vez creado o unido) -->
      <div id="roomInfo" style="display: none;">
        <p id="roomCodeDisplay"></p>
        <div id="playersList">
          <p>Connected players:</p>
          <ul id="playersUl"></ul>
        </div>
        <!-- Controles para el creador: INICIAR y CERRAR SALA -->
        <div id="creatorControls" style="display: none;">
          <button id="startGameBtn" class="btn-start">START GAME</button>
          <button id="cerrarSalaBtn" class="btn-close">Close Room</button>
        </div>
        <!-- Controles para jugadores (no creador): sólo SALIR -->
        <div id="playerControls" style="display: none;">
          <button id="leaveRoomBtn" class="btn-leave">Go out</button>
        </div>
      </div>
    </div>
    
    <!-- Sección de Juego -->
    <div id="game" style="display: none;">
      <div id="game-header">
        <p>Room code: <span id="roomCodeGame"></span></p>
        <p id="playersInfo"></p>
        <p id="countdownText"></p>
      </div>
      <h1>Click PvP Online</h1>
      <p>Remaining time: <span id="timer"></span> seconds</p>
      <p>Clicks: <span id="clicks"></span></p>
      <div class="circle" id="circle"></div>
      <p id="result"></p>
    </div>
    
    <!-- Pantalla de estadísticas -->
    <div id="stats"></div>
    
    <!-- Sección para sala cerrada -->
    <div id="roomClosed" style="display: none;"></div>
  </div>
  
  <!-- Notificación personalizada -->
  <div id="notification">
    <div id="notification-content">
      <p id="notification-text"></p>
      <button id="notification-close">Accept</button>
    </div>
  </div>
  
  <!-- particles.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script>
    const localVersion = 'clickpvponline1.0.1';

    if (!navigator.onLine) {
      window.location.href = 'error_internet.html';
    }
    fetch(`${baseUrl}/version`)
      .then(response => response.json())
      .then(data => {
        if (data.version !== localVersion) {
          // Si hay una versión nueva, redirige a actualizar.html
          window.location.href = 'actualizar.html';
        }
      })
      .catch(error => {
        showNotification('Connection error.');
      });
	  
    const baseMoveSound = new Audio('assets/move.mp3');
    baseMoveSound.load();
    document.querySelectorAll("button").forEach(button => {
      button.addEventListener("click", () => {
        let moveSound = baseMoveSound.cloneNode();
        moveSound.play();
      });
    });

    // Inicialización de partículas de fondo
    particlesJS("particles-js", {
      "particles": {
        "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
        "color": { "value": "#ffffff" },
        "shape": { "type": "circle", "stroke": { "width": 0, "color": "#000000" }, "polygon": { "nb_sides": 5 } },
        "opacity": { "value": 0.5, "random": false, "anim": { "enable": false } },
        "size": { "value": 3, "random": true, "anim": { "enable": false } },
        "line_linked": { "enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.4, "width": 1 },
        "move": { "enable": true, "speed": 2, "direction": "none", "random": false, "straight": false, "out_mode": "out" }
      },
      "interactivity": {
        "detect_on": "canvas",
        "events": {
          "onhover": { "enable": true, "mode": "repulse" },
          "onclick": { "enable": true, "mode": "push" },
          "resize": true
        },
        "modes": {
          "grab": { "distance": 400, "line_linked": { "opacity": 1 } },
          "bubble": { "distance": 400, "size": 40, "duration": 2 },
          "repulse": { "distance": 200, "duration": 0.4 },
          "push": { "particles_nb": 4 },
          "remove": { "particles_nb": 2 }
        }
      },
      "retina_detect": true
    });
    
    // Notificación personalizada
    function showNotification(message) {
      const notification = document.getElementById("notification");
      const notificationText = document.getElementById("notification-text");
      notificationText.textContent = message;
      notification.style.display = "flex";
    }
    document.getElementById("notification-close").addEventListener("click", function() {
      document.getElementById("notification").style.display = "none";
    });
    
    // Dirección base del servidor
    const baseUrl = './api';
    window.addEventListener('offline', function() {
      window.location.href = 'error_internet.html';
    });
    window.addEventListener('unhandledrejection', function(event) {
      showNotification('Connection error.');
    });
    
    // Variables globales
    let roomCodeGlobal = "";
    let myUsername = "";
    let timeLeft = 10;
    let clickCount = 0;
    let gameInterval;
    let pollInterval;
    let heartbeatInterval; // Para el heartbeat del creador
    let currentRoom = null;
    let isPracticeMode = false; // Bandera para Practice Mode
    
    // Elementos del DOM
    const lobbyDiv = document.getElementById('lobby');
    const gameDiv = document.getElementById('game');
    const statsDiv = document.getElementById('stats');
    const roomInfo = document.getElementById('roomInfo');
    const joinSection = document.getElementById('joinSection');
    const container = document.getElementById('container');
    
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const randomRoomBtn = document.getElementById('randomRoomBtn');
    const practiceModeBtn = document.getElementById('practiceModeBtn');
    const confirmJoinBtn = document.getElementById('confirmJoinBtn');
    const backBtn = document.getElementById('backBtn');
    
    const usernameInput = document.getElementById('username');
    const roomCodeInput = document.getElementById('roomCodeInput');
    
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const playersUl = document.getElementById('playersUl');
    
    const roomCodeGame = document.getElementById('roomCodeGame');
    const playersInfo = document.getElementById('playersInfo');
    const countdownText = document.getElementById('countdownText');
    const timerDisplay = document.getElementById('timer');
    const clicksDisplay = document.getElementById('clicks');
    const resultDisplay = document.getElementById('result');
    const circle = document.getElementById('circle');
    
    // Botones para iniciar, cerrar y salir
    const startGameBtn = document.getElementById('startGameBtn');
    const cerrarSalaBtn = document.getElementById('cerrarSalaBtn');
    const leaveRoomBtn = document.getElementById('leaveRoomBtn');
    
    // Función para iniciar heartbeat (solo para el creador)
    function startHeartbeat() {
      // Envía un ping cada 5 segundos
      heartbeatInterval = setInterval(() => {
        fetch(`${baseUrl}/ClickPvPOnline/heartbeat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: myUsername, roomCode: roomCodeGlobal })
        }).catch(err => console.error(err));
      }, 5000);
    }
    
    function stopHeartbeat() {
      clearInterval(heartbeatInterval);
    }
    
    // Evento: Crear sala
    createRoomBtn.addEventListener('click', () => {
      const username = usernameInput.value.trim();
      if (!username) {
        showNotification('Please enter a username.');
        return;
      }
      myUsername = username;
      document.getElementById("mainButtons").style.display = 'none';
      joinSection.style.display = 'none';
      
      fetch(`${baseUrl}/ClickPvPOnline/createRoom`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          roomCodeGlobal = data.roomCode;
          roomCodeDisplay.textContent = 'Room code: ' + roomCodeGlobal;
          roomInfo.style.display = 'block';
          startPollingRoomStatus();
        } else {
          showNotification(data.message);
          document.getElementById("mainButtons").style.display = 'flex';
        }
      })
      .catch(err => {
        console.error(err);
        showNotification('Error creating room.');
        document.getElementById("mainButtons").style.display = 'flex';
      });
    });
    
    // Evento: Mostrar sección para unirse a sala
    joinRoomBtn.addEventListener('click', () => {
      const username = usernameInput.value.trim();
      if (!username) {
        showNotification('Please enter a username.');
        return;
      }
      myUsername = username;
      document.getElementById("mainButtons").style.display = 'none';
      joinSection.style.display = 'block';
    });
    
    // Evento: Regresar al menú principal desde la sección de unirse
    backBtn.addEventListener('click', () => {
      joinSection.style.display = 'none';
      document.getElementById("mainButtons").style.display = 'flex';
    });
    
    // Evento: Unirse a sala
    confirmJoinBtn.addEventListener('click', () => {
      const username = usernameInput.value.trim();
      const roomCode = roomCodeInput.value.trim();
      if (!username || !roomCode) {
        showNotification('Please enter all the data.');
        return;
      }
      myUsername = username;
      fetch(`${baseUrl}/ClickPvPOnline/joinRoom`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, roomCode })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          roomCodeGlobal = data.roomCode;
          roomCodeDisplay.textContent = 'Room code: ' + roomCodeGlobal;
          roomInfo.style.display = 'block';
          joinSection.style.display = 'none';
          document.getElementById("mainButtons").style.display = 'none';
          backBtn.style.display = 'none';
          startPollingRoomStatus();
        } else {
          showNotification(data.message);
        }
      })
      .catch(err => {
        console.error(err);
        showNotification('Failed to join room.');
      });
    });
    
    // Evento: Random Room – unirse a una sala aleatoria (sólo salas automáticas con menos de 4 jugadores)
    randomRoomBtn.addEventListener('click', () => {
      const username = usernameInput.value.trim();
      if (!username) {
        showNotification('Please enter a username.');
        return;
      }
      myUsername = username;
      document.getElementById("mainButtons").style.display = 'none';
      joinSection.style.display = 'none';
      
      // Se asume que el servidor maneja el endpoint joinRandomRoom
      fetch(`${baseUrl}/ClickPvPOnline/joinRandomRoom`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          roomCodeGlobal = data.roomCode;
          roomCodeDisplay.textContent = 'Room code: ' + roomCodeGlobal;
          roomInfo.style.display = 'block';
          startPollingRoomStatus();
        } else {
          showNotification(data.message);
          document.getElementById("mainButtons").style.display = 'flex';
        }
      })
      .catch(err => {
        console.error(err);
        showNotification('Error joining random room.');
        document.getElementById("mainButtons").style.display = 'flex';
      });
    });
    
    // Evento: Practice Mode – jugar solo, sin conectarse al servidor
    practiceModeBtn.addEventListener('click', () => {
      const username = usernameInput.value.trim();
      if (!username) {
        showNotification('Please enter a username.');
        return;
      }
      isPracticeMode = true;
      myUsername = username;
      document.getElementById("mainButtons").style.display = 'none';
      lobbyDiv.style.display = 'none';
      roomInfo.style.display = 'none';
      joinSection.style.display = 'none';
      document.getElementById("roomClosed").style.display = "none";
      
      // Configuración de la partida en Practice Mode
      gameDiv.style.display = 'block';
      roomCodeGame.textContent = 'Practice Mode';
      playersInfo.textContent = 'Solo play';
      countdownText.textContent = '';
      timeLeft = 10;
      clickCount = 0;
      timerDisplay.textContent = timeLeft;
      clicksDisplay.textContent = clickCount;
      resultDisplay.textContent = "";
      circle.style.pointerEvents = "none";
      startGameCountdown();
    });
    
    // Evento: INICIAR (solo para el creador)
    startGameBtn.addEventListener('click', () => {
      if (currentRoom && currentRoom.players.length < 2) {
        showNotification('Wait for more players to join.');
        return;
      }
      fetch(`${baseUrl}/ClickPvPOnline/startGame`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: myUsername, roomCode: roomCodeGlobal })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          clearInterval(pollInterval);
          stopHeartbeat();
          iniciarJuego();
        } else {
          showNotification(data.message);
        }
      })
      .catch(err => {
        console.error(err);
        showNotification('Error when starting the game.');
      });
    });
    
    // Evento: Cerrar sala (solo para el creador)
    cerrarSalaBtn.addEventListener('click', () => {
      fetch(`${baseUrl}/ClickPvPOnline/deleteRoom`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ roomCode: roomCodeGlobal })
      })
      .then(response => response.json())
      .then(data => {
        showNotification(data.message);
        resetLobby();
      })
      .catch(err => console.error(err));
    });
    
    // Evento: Salir de sala (para jugadores que no son creadores)
    leaveRoomBtn.addEventListener('click', () => {
      clearInterval(pollInterval);
      fetch(`${baseUrl}/ClickPvPOnline/leaveRoom`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: myUsername, roomCode: roomCodeGlobal })
      })
      .then(response => response.json())
      .then(data => {
        showNotification(data.message);
        resetLobby();
      })
      .catch(err => console.error(err));
    });
    
    // Polling para actualizar el estado de la sala
    function startPollingRoomStatus() {
      pollInterval = setInterval(() => {
        fetch(`${baseUrl}/ClickPvPOnline/roomStatus?roomCode=${roomCodeGlobal}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              currentRoom = data.room;
              updateRoomInfo(currentRoom);
              if (currentRoom.status === "playing") {
                clearInterval(pollInterval);
                stopHeartbeat();
                iniciarJuego();
              }
            } else {
              clearInterval(pollInterval);
              stopHeartbeat();
              showRoomClosedMessage();
            }
          })
          .catch(err => console.error(err));
      }, 2000);
    }
    
    // Actualiza la UI de la sala: lista de jugadores y controles según el rol
    function updateRoomInfo(room) {
      playersUl.innerHTML = "";
      room.players.forEach(player => {
        const li = document.createElement("li");
        li.textContent = player + (player === room.creator ? " (room creator)" : "");
        playersUl.appendChild(li);
      });
      
      if (myUsername === room.creator) {
        document.getElementById("creatorControls").style.display = "block";
        document.getElementById("playerControls").style.display = "none";
        if (room.players.length >= 2) {
          startGameBtn.classList.add("active");
          startGameBtn.disabled = false;
        } else {
          startGameBtn.classList.remove("active");
          startGameBtn.disabled = true;
        }
        // Inicia el heartbeat si aún no se inició
        if (!heartbeatInterval) {
          startHeartbeat();
        }
      } else {
        document.getElementById("creatorControls").style.display = "none";
        document.getElementById("playerControls").style.display = "block";
      }
    }
    
    // Función para mostrar mensaje de sala cerrada
    function showRoomClosedMessage() {
      lobbyDiv.style.display = 'none';
      gameDiv.style.display = 'none';
      statsDiv.style.display = 'none';
      roomInfo.style.display = 'none';
      joinSection.style.display = 'none';
      document.getElementById("roomClosed").style.display = "block";
      document.getElementById("roomClosed").innerHTML = `
        <h1>La sala ha sido cerrada</h1>
        <p>${currentRoom ? currentRoom.creator : "The creator"} closed the room.</p>
        <button id="backToMenu" class="btn-back">Return to menu</button>
      `;
      document.getElementById("backToMenu").addEventListener("click", resetLobby);
    }
    
    // Inicia la transición al juego
    function iniciarJuego() {
      lobbyDiv.style.display = 'none';
      gameDiv.style.display = 'block';
      roomCodeGame.textContent = roomCodeGlobal;
      if (currentRoom) {
        playersInfo.textContent = "Players: " + currentRoom.players.map(p => p + (p === currentRoom.creator ? " (room creator)" : "")).join(", ");
      }
      timeLeft = 10;
      clickCount = 0;
      timerDisplay.textContent = timeLeft;
      clicksDisplay.textContent = clickCount;
      resultDisplay.textContent = "";
      circle.style.pointerEvents = "none";
      startGameCountdown();
    }
    
    // Cuenta regresiva de 5 segundos antes de iniciar la prueba de clicks
    const baseCountSound = new Audio('assets/count.mp3');
    baseCountSound.load();

    function startGameCountdown() {
      let countdown = 5;
      countdownText.textContent = "The game starts in: " + countdown;
      const countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          countdownText.textContent = "The game starts in: " + countdown;
          // Reproducir sonido count.mp3 cada vez que pasa un segundo
          let countSound = baseCountSound.cloneNode();
          countSound.play();
        } else {
          clearInterval(countdownInterval);
          countdownText.textContent = "";
          circle.style.pointerEvents = "auto";
          startClickGame();
        }
      }, 1000);
    }
    
    // Inicia la prueba de clicks (10 segundos)
    function startClickGame() {
      gameInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(gameInterval);
          circle.style.pointerEvents = "none";
          let cps = (clickCount / 10).toFixed(2);
          resultDisplay.textContent = `You did ${clickCount} clicks. (${cps} CPS)`;
          if (!isPracticeMode) {
              submitScore(clickCount);
              pollWinner();
          } else {
              resultDisplay.textContent += " (Practice Mode)";
              setTimeout(resetLobby, 3000);
          }
        }
      }, 1000);
    }
    
    // Crea partículas en el círculo al hacer click
    function createClickParticles(x, y) {
      for (let i = 0; i < 5; i++) {
        const particle = document.createElement('div');
        particle.className = 'click-particle';
        const dx = (Math.random() - 0.5) * 40;
        const dy = (Math.random() - 0.5) * 40;
        particle.style.left = (x + dx) + 'px';
        particle.style.top = (y + dy) + 'px';
        circle.appendChild(particle);
        setTimeout(() => { particle.remove(); }, 600);
      }
    }
    
    // Incrementa clicks y genera partículas al hacer click
    const baseClickSound = new Audio('assets/click.mp3');
    baseClickSound.load();
	
    circle.addEventListener("click", (e) => {
      if (circle.style.pointerEvents === "auto") {
        clickCount++;
        clicksDisplay.textContent = clickCount;
        createClickParticles(e.offsetX, e.offsetY);
        
        let clickSound = baseClickSound.cloneNode();
        clickSound.play();
      }
    });
    
    // Envía el score al servidor
    function submitScore(score) {
      fetch(`${baseUrl}/ClickPvPOnline/submitScore`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: myUsername, roomCode: roomCodeGlobal, score })
      })
      .then(response => response.json())
      .then(data => console.log(data.message))
      .catch(err => console.error(err));
    }
    
    // Polling para obtener el ganador y mostrar estadísticas
    function pollWinner() {
      const winnerInterval = setInterval(() => {
        fetch(`${baseUrl}/ClickPvPOnline/roomStatus?roomCode=${roomCodeGlobal}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const room = data.room;
              if (room.winner) {
                clearInterval(winnerInterval);
                showGameStats(room);
                setTimeout(() => { deleteRoom(false); }, 3000);
              }
            }
          })
          .catch(err => console.error(err));
      }, 2000);
    }
    
    // Muestra las estadísticas de la partida
    function showGameStats(room) {
      lobbyDiv.style.display = 'none';
      gameDiv.style.display = 'none';
      roomInfo.style.display = 'none';
      joinSection.style.display = 'none';
      document.getElementById("roomClosed").style.display = "none";

      let statsHTML = `<div>
          <h2>GAME STATISTICS</h2>
          <p><strong>Players:</strong></p>`;
      room.players.forEach(function(player) {
        let score = room.scores[player] || 0;
        let cps = (score / 10).toFixed(2);
        let creatorLabel = (player === room.creator) ? " (room creator)" : "";
        statsHTML += `<p>${player}${creatorLabel}: ${score} Clicks (${cps} CPS)</p>`;
      });
      statsHTML += `<br>
          <p><strong>Winner:</strong> ${room.winner}</p>
          <br>
          <button class="btn-back" id="exitBtn">GO OUT</button>
        </div>`;
      statsDiv.innerHTML = statsHTML;
      statsDiv.style.display = "flex";
      document.getElementById("exitBtn").addEventListener("click", deleteRoom);
    }
    
    // Función para eliminar la sala y reiniciar la UI
    function deleteRoom(resetUI = true) {
      fetch(`${baseUrl}/ClickPvPOnline/deleteRoom`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ roomCode: roomCodeGlobal })
      })
      .then(response => response.json())
      .then(data => {
        console.log(data.message);
        if (resetUI) {
          resetLobby();
        }
      })
      .catch(err => console.error(err));
    }
    
    // Resetea la interfaz al menú principal y cancela intervalos activos
    function resetLobby() {
      clearInterval(pollInterval);
      clearInterval(gameInterval);
      stopHeartbeat();
      statsDiv.style.display = 'none';
      gameDiv.style.display = 'none';
      lobbyDiv.style.display = 'block';
      document.getElementById("mainButtons").style.display = 'flex';
      roomInfo.style.display = 'none';
      joinSection.style.display = 'none';
      document.getElementById("roomClosed").style.display = "none";
      roomCodeGlobal = "";
      currentRoom = null;
      isPracticeMode = false;
    }
    
    // Evento pagehide: si se cierra o recarga la página, notificar al servidor.
    window.addEventListener("pagehide", function() {
      if (roomCodeGlobal) {
        let endpoint;
        if (currentRoom && myUsername === currentRoom.creator) {
          endpoint = `${baseUrl}/ClickPvPOnline/deleteRoom`;
          var payload = { roomCode: roomCodeGlobal };
        } else {
          endpoint = `${baseUrl}/ClickPvPOnline/leaveRoom`;
          var payload = { username: myUsername, roomCode: roomCodeGlobal };
        }
        let blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        navigator.sendBeacon(endpoint, blob);
      }
    });
  </script>
</body>
</html>
